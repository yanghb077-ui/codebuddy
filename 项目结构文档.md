# 健身记录App - 项目结构文档

## 一、总体应用架构

本项目采用 **前后端分离架构**，遵循MVC设计模式，实现高内聚低耦合的模块化设计。

### 架构分层

```
┌─────────────────────────────────────────────────────────────────────┐
│                            前端层 (React)                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌───────┐ │
│  │  首页    │  │ 训练页   │  │ 日历页   │  │ 综合分析 │  │API服务│ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └───────┘ │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                        HTTP/HTTPS (Axios)
                                  │
┌─────────────────────────────────────────────────────────────────────┐
│                           后端层 (Node.js)                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌───────┐ │
│  │ 路由层   │  │ 控制器   │  │ 服务层   │  │ 数据模型 │  │用户验证│ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └───────┘ │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                             Mongoose ORM
                                  │
┌─────────────────────────────────────────────────────────────────────┐
│                         数据存储层 (MongoDB)                        │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  Workout集合(含username) │  Exercise集合  │  索引优化  │ 日志│  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

### 技术栈

| 层级 | 技术 | 用途 |
|------|------|------|
| **前端** | React 18 + Vite | 构建用户界面 |
| | React Router | 单页应用路由管理 |
| | Styled Components | 组件化CSS样式 |
| | Axios | HTTP客户端请求 |
| | Chart.js + react-chartjs-2 | 图表可视化 |
| **后端** | Node.js + Express | RESTful API服务器 |
| | Mongoose | MongoDB对象建模 |
| | CORS | 跨域资源共享 |
| **数据库** | MongoDB 4.0+ | NoSQL文档存储 |
| **工具** | dotenv | 环境变量管理 |
| | JSDoc | 代码文档生成 |

---

## 二、脚本文件说明

### 1. 启动脚本

#### `start-backend.bat` (Windows批处理)
**位置**: `c:\6318 project\6318 project\codebuddy\start-backend.bat`

**作用**:
- 自动进入后端目录
- 检查package.json是否存在
- 执行 `npm install` 安装依赖
- 启动后端服务器 (`node server.js`)
- 错误处理和日志输出

**使用**: 双击运行，自动完成后端环境配置和启动

#### `start-frontend.bat` (Windows批处理)
**位置**: `c:\6318 project\6318 project\codebuddy\start-frontend.bat`

**作用**:
- 自动进入前端目录
- 检查package.json是否存在
- 执行 `npm install` 安装依赖
- 启动Vite开发服务器 (`npm run dev`)
- 显示访问地址

**使用**: 双击运行，自动完成前端环境配置和启动

### 2. 后端核心脚本

#### `backend/server.js`
**位置**: `c:\6318 project\6318 project\codebuddy\backend\server.js`

**作用**:
- 应用主入口
- 初始化Express服务器
- 配置中间件（CORS、body-parser）
- 注册路由
- 连接MongoDB数据库
- 错误处理和优雅关闭

**启动命令**: `node server.js` 或 `npm start`

#### `backend/config/database.js`
**位置**: `c:\6318 project\6318 project\codebuddy\backend\config\database.js`

**作用**:
- 封装MongoDB连接逻辑
- 实现单例模式数据库连接
- 连接状态管理
- 错误处理和重连机制

**导出**: Database类实例

### 3. 前端核心脚本

#### `frontend/src/main.jsx`
**位置**: `c:\6318 project\6318 project\codebuddy\frontend\src\main.jsx`

**作用**:
- React应用入口
- 配置BrowserRouter
- 渲染App组件

#### `frontend/src/components/UserLogin.jsx`
**位置**: `c:\6318 project\6318 project\codebuddy\frontend\src\components\UserLogin.jsx`

**作用**:
- 用户登录界面组件
- 用户名输入与验证
- 最近用户列表显示
- 登录状态管理

**验证规则**:
- 长度2-20个字符
- 只允许字母、数字、中文、下划线
- 区分大小写

**存储**:
- 当前用户: `localStorage.setItem('fitness_username', username)`
- 最近用户: `localStorage.setItem('fitness_recent_users', JSON.stringify(users))`

#### `frontend/src/services/api.js`
**位置**: `c:\6318 project\6318 project\codebuddy\frontend\src\services\api.js`

**作用**:
- 封装所有API请求
- Axios实例配置
- 请求/响应拦截器（自动附加username）
- 统一的错误处理
- 按模块导出API对象

**导出**:
- `workoutAPI`: 训练记录相关API
- `exerciseAPI`: 动作库相关API
- `api`: Axios实例（高级使用）

**拦截器特性**:
- 自动从localStorage读取username
- GET请求: 附加到params
- POST/PUT请求: 附加到data

---

## 三、API接口文档

### 1. 训练记录API (Workout API)

**基础路径**: `http://localhost:5000/api/workouts`

**认证要求**: 所有接口需要 `username` 参数进行用户身份识别

| 方法 | 路径 | 参数 | 请求体 | 响应 | 说明 |
|------|------|------|--------|------|------|
| **POST** | `/` | - | `{username, date, exercises, ...}` | `{success, data}` | 创建新训练（需username） |
| **GET** | `/` | `username, limit, offset` | - | `{success, count, data}` | 获取用户所有训练 |
| **GET** | `/recent` | `username, days` | - | `{success, count, data}` | 获取用户最近N天训练 |
| **GET** | `/recent-7-days-brief` | `username` | - | `{success, count, data}` | 获取用户7天训练简报 |
| **GET** | `/stats` | `username, days` | - | `{success, data}` | 获取用户训练统计 |
| **GET** | `/:id` | `id` | - | `{success, data}` | 获取单个训练 |
| **GET** | `/date/:date` | `username, date` | - | `{success, data}` | 获取用户指定日期训练 |
| **PUT** | `/:id` | `id` | `updateData` | `{success, data}` | 更新训练 |
| **DELETE** | `/:id` | `id` | - | `{success}` | 删除训练 |
| **POST** | `/:id/exercises` | `id` | `{exerciseId}` | `{success, data}` | 添加动作到训练 |
| **POST** | `/:id/sets` | `id` | `{exerciseIndex, weight, reps}` | `{success, data}` | 添加组数 |
| **POST** | `/:id/complete-set` | `id` | `{exerciseIndex, setIndex}` | `{success, data}` | 完成某组 |
| **DELETE** | `/:id/sets` | `id, exerciseIndex, setIndex` | - | `{success, data}` | 删除某组 |
| **POST** | `/:id/complete` | `id` | - | `{success, data}` | 完成训练 |
| **GET** | `/exercise-history/:exerciseId` | `username, days` | - | `{success, data}` | 动作历史与分析 |
| **GET** | `/overview` | `username, days` | - | `{success, data}` | 综合训练分析 |

**用户隔离说明**:
- GET请求: 通过 `?username=xxx` query参数传递
- POST/PUT请求: 通过请求体 `{ username: "xxx" }` 传递
- 错误响应: 缺少username时返回 `400 Bad Request`

#### API调用示例 (前端)

```javascript
import { workoutAPI } from '../services/api';

// 注意：username 会自动通过请求拦截器附加，无需手动传入
// 只需在登录时设置：localStorage.setItem('fitness_username', 'zhangsan');

// 1. 创建新训练（自动携带username）
const response = await workoutAPI.createWorkout();
const workoutId = response.data._id;

// 2. 获取当前用户最近7天简报
const briefs = await workoutAPI.getRecent7DaysBrief();

// 3. 添加动作到训练
await workoutAPI.addExerciseToWorkout(workoutId, exerciseId);

// 4. 添加组数
await workoutAPI.addSetToWorkout(workoutId, 0, 50, 12); // 第0个动作，50kg，12次

// 5. 完成某组
await workoutAPI.completeSetInWorkout(workoutId, 0, 0); // 第0个动作的第0组

// 6. 完成训练
await workoutAPI.completeWorkout(workoutId);

// 7. 删除某组
await workoutAPI.deleteSetFromWorkout(workoutId, 0, 0);

// 8. 动作历史与分析
const history = await workoutAPI.getExerciseHistory(exerciseId, 180);

// 9. 综合训练分析
const overview = await workoutAPI.getWorkoutOverview(30);
```

**Axios拦截器配置**:
```javascript
// 请求拦截器自动处理username
api.interceptors.request.use((config) => {
  const username = localStorage.getItem('fitness_username');
  if (username) {
    if (config.method === 'get') {
      config.params = { ...config.params, username };
    } else {
      config.data = { ...config.data, username };
    }
  }
  return config;
});
```

---

### 2. 动作库API (Exercise API)

**基础路径**: `http://localhost:5000/api/exercises`

| 方法 | 路径 | 参数 | 请求体 | 响应 | 说明 |
|------|------|------|--------|------|------|
| **POST** | `/` | - | `{name, bodyPart, difficulty}` | `{success, data}` | 创建新动作 |
| **GET** | `/` | `bodyPart, difficulty, limit` | - | `{success, count, data}` | 获取所有动作 |
| **GET** | `/search` | `keyword` | - | `{success, count, data}` | 搜索动作 |
| **GET** | `/stats` | - | - | `{success, data}` | 获取动作统计 |
| **GET** | `/bodypart/:bodyPart` | `bodyPart` | - | `{success, count, data}` | 按部位获取 |
| **GET** | `/difficulty/:difficulty` | `difficulty` | - | `{success, count, data}` | 按难度获取 |
| **GET** | `/:id` | `id` | - | `{success, data}` | 获取单个动作 |
| **PUT** | `/:id` | `id` | `updateData` | `{success, data}` | 更新动作 |
| **DELETE** | `/:id` | `id` | - | `{success}` | 删除动作 |
| **POST** | `/initialize` | - | - | `{success, count, data}` | 初始化默认动作 |

#### API调用示例 (前端)

```javascript
import { exerciseAPI } from '../services/api';

// 1. 获取所有动作
const exercises = await exerciseAPI.getAllExercises();

// 2. 按部位筛选
const chestExercises = await exerciseAPI.getExercisesByBodyPart('胸');

// 3. 搜索动作
const results = await exerciseAPI.searchExercises('卧推');

// 4. 创建新动作
await exerciseAPI.createExercise({
  name: '哑铃弯举',
  bodyPart: '手臂',
  difficulty: '初级'
});

// 5. 初始化默认动作（首次运行）
await exerciseAPI.createDefaultExercises();
```

---

### 3. 健康检查API

**基础路径**: `http://localhost:5000`

| 方法 | 路径 | 说明 |
|------|------|------|
| **GET** | `/api/health` | 检查服务器状态 |
| **GET** | `/` | 获取API信息 |

---

## 四、前端连接方式

### Axios配置

**文件**: `frontend/src/services/api.js`

```javascript
const api = axios.create({
  baseURL: '/api',  // Vite代理转发到后端
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json'
  }
});
```

### Vite代理配置

**文件**: `frontend/vite.config.js`

```javascript
server: {
  port: 5173,
  proxy: {
    '/api': {
      target: 'http://localhost:5000',  // 后端地址
      changeOrigin: true
    }
  }
}
```

### API模块导出

```javascript
export const workoutAPI = { /* 训练记录API */ };
export const exerciseAPI = { /* 动作库API */ };
export default { workoutAPI, exerciseAPI, api };
```

### 使用方式

```javascript
import { workoutAPI, exerciseAPI } from './services/api';

// 使用
const response = await workoutAPI.getRecentWorkouts(30);
if (response.success) {
  setWorkouts(response.data);
}
```

---

## 五、数据流示意图

### 用户认证流程

```
用户: 打开应用
  ↓
前端: 检查 localStorage.getItem('fitness_username')
  ↓ (无用户名)
前端: 显示 UserLogin 组件
  ↓ (输入用户名)
前端: 验证用户名格式
  ↓ (验证通过)
前端: 保存到 localStorage
  ↓ (登录成功)
前端: 显示主应用界面
```

### 创建训练流程（含用户隔离）

```
前端: 点击"开启训练"
  ↓ (调用)
API: POST /api/workouts
  ↓ (拦截器自动附加username)
请求体: { username: "zhangsan", date: "..." }
  ↓
后端: workoutController.createWorkout()
  ↓ (验证username存在)
后端: 验证 username 不为空
  ↓ (调用)
服务: workoutService.createWorkout()
  ↓ (操作)
模型: Workout.create({ username, ... })
  ↓ (存储)
数据库: fitness-tracker.workouts集合（含username字段）
  ↓ (返回)
前端: 获取workoutId，跳转到训练页面
```

### 完成组数流程

```
前端: 点击"完成"按钮
  ↓ (调用)
API: POST /api/workouts/:id/complete-set
  ↓ (请求)
后端: workoutController.completeSetInWorkout()
  ↓ (调用)
服务: workoutService.completeSetInWorkout()
  ↓ (操作)
模型: workout.completeSet()
  ↓ (更新)
数据库: 更新sets数组，标记completed=true
  ↓ (返回)
前端: 更新UI状态，显示"✓ 已完成"
```

---

## 六、项目目录树

```
c:\6318 project\6318 project\codebuddy\
├── backend/                    # 后端代码
│   ├── config/                 # 数据库配置
│   │   └── database.js          # 数据库连接配置
│   ├── controllers/            # 控制器层
│   │   ├── exerciseController.js # 动作库控制器
│   │   └── workoutController.js  # 训练记录控制器
│   ├── models/                 # 数据模型层
│   │   ├── Exercise.js          # 动作库模型
│   │   └── Workout.js           # 训练记录模型
│   ├── routes/                 # 路由配置
│   │   ├── exerciseRoutes.js    # 动作库路由
│   │   └── workoutRoutes.js     # 训练记录路由
│   ├── services/               # 业务逻辑层
│   │   ├── exerciseService.js   # 动作库业务逻辑
│   │   └── workoutService.js    # 训练记录业务逻辑
│   ├── utils/                  # 工具函数
│   │   └── logger.js            # 日志工具
│   ├── .env                     # 环境变量
│   ├── package.json             # 后端依赖配置
│   └── server.js                # 后端入口
│
├── frontend/                   # 前端代码
│   ├── src/
│   │   ├── components/          # 组件目录
│   │   │   └── UserLogin.jsx    # 用户登录组件
│   │   ├── services/
│   │   │   └── api.js           # API接口封装（含username拦截器）
│   │   ├── App.jsx              # 主应用组件（集成用户认证）
│   │   ├── index.css            # 全局样式
│   │   └── main.jsx             # 前端入口
│   ├── index.html               # HTML模板
│   ├── package.json             # 前端依赖配置
│   └── vite.config.js           # Vite配置
│
├── start-backend.bat            # 后端启动脚本
├── start-frontend.bat           # 前端启动脚本
├── 快速开始指南.md             # 快速入门文档
└── README.md                    # 完整项目文档
```

---

## 七、API响应格式规范

所有API统一返回格式：

```json
{
  "success": true,        // 布尔值，表示请求是否成功
  "message": "操作成功",  // 可选，操作描述
  "data": { ... },        // 可选，返回的数据
  "count": 10             // 可选，列表数量
}
```

错误响应：

```json
{
  "success": false,
  "message": "错误描述信息"
}
```

---

**文档完成！** 所有API已按模块分类，连接方式已标准化封装。如需调整或扩展功能，请告诉我！
